=========================================================
C-ESM-EP user guide for the case of a libIGCM simulation
=========================================================

S.Senesi - sept 2022

Pre-requisites :
  - some basic knowledege of C-ESM-EP (i.e. organization of a C-ESM-EP home directory, concept of a 'comparison')
  - how to run a libIGCM simulation


When running a simulation (yet only on irene and irene-rome) you can trigger the computation of a C-ESM-EP atlas based on one of the output types (Seasonal, TimeSeries, packed Output, or even Output on scratch for e.g. a TEST simulation). This works when using a libIGCM version from trunk with a release number >= xxx

The atlas shows a series of the most recent time slices of the running simulation. Slices number and duration are tunable. 

Basic use
===========

Init phase
----------

Because C-ESM-EP requires a number of software packages, C-ESM-EP uses TGCC's tool 'pcocc' (see https://pcocc.readthedocs.io/) and you must tell pcocc where to find a relevant environment, by interactively issuing this command :

>	pcocc image import docker-archive:~igcmg/Tools/climaf/climaf_spirit_a.tar cesmep_container

This should be done only once by each user. The path above is correct at the time of writing and may change in the future. 
	

Settings:
---------

Computing a C-ESM-EP atlas is triggered using parameter 'Cesmep' in section Post of the config.card, which can be set to :

  - TRUE, or <nyears>Y, for using the most efficient output type (among those which are generated by the simulation, so SE else TS else packed Outputs). The form <nyears>Y allows to explicitly set the atlas time slice duration (hereafter called CesmepPeriod)
  - SE, TS, or Pack, for selecting explicitly an output type and its time slice duration (CesmepPeriod); that output type should be activated independently
  - AtEnd for running the atlas only at simulation end, from Output type data (this works for TEST simulation with output on scratch)
  - FALSE for deactivating any C-ESM-EP atlas (which is the default)

In section Post of the config.card parameter 'CesmepSlices' allows to set the number of time slices to show in atlas (it defaults to 8).

Example of config.card minimal content (in section 'Post')::

  #D- Activate C-ESM-EP atlas by setting Cesmep to TRUE or to a number of years or ...
  Cesmep=5Y



How it works
------------

The C-ESM-EP code (from a reference code version) is partially copied to $SUMBIT_DIR/cesemp_lite/, which becomes the root C-ESM-EP directory for that simulation.

The C-ESM-EP comparison that is ran is by default 'run_comparison' and, in directory cesmep_lite/, that comparison name is further prefixed by your JobName (this matters when looking for outputs, see below)

Except for case AtEnd , the atlas is computed each time a batch of output is available for the selected type, provided it allows to process a new time slice. Time slicing is aligned with simulation start date and complies with values for parameters CesmepSlices and CesmepPeriod.



Outputs 
----------

The standard output of last C-ESM-EP launch is availabe in $SUMBIT_DIR/cesemp_lite/libIGCM_post.out, and the output for each component is located, as for all C-ESM-EP runs, in the component directory

The atlas main page is available on thredds/work like for other C-ESM-EP simulation e.g., if JobName is 'myFG2', atlas main index can be found at:
   https://thredds-su.ipsl.fr/thredds/fileServer/tgcc_thredds/work/senesis/C-ESM-EP/myFG2_mycomparison_senesis/C-ESM-EP_myFG2_mycomparison.html

The actual value for your simulation can be found in the file above, $SUMBIT_DIR/cesemp_lite/libIGCM_post.out 


Advanced use
============

The version of C-ESM-EP code used is located by default (on Irene) at ~igcmg/Tools/cesmep; this can be changed using config.card's Post section's parameter 'CesmepCode'; 

The C-ESM-EP comparison used can be chosen using config.card's Post parameter 'CesmepComparison'.

The comparison 'components' are activated based on the simulation physical components; their list can be changed manually after running ins_job (in $SUMBIT_DIR/cesemp_lite/libIGCM_post.param, which fields are Cesmep code location, comparison name, simulation start date, cache location, components list)

At that stage, you may also change component parameters in component directories in $SUMBIT_DIR/cesemp_lite/. You may also make changes to the datasets_setup.py source for customizing the datasets to use; for that, you can make use of the variables available in comparison's directory file libIGCM_fixed_settings.py, as e.g. :: 

   root           = '/ccc/store/cont003/gen0826'
   Login          = 'senesis'
   TagName        = 'IPSLCM6'
   SpaceName      = 'DEVT'
   ExpType        = 'piControl'
   ExperimentName = 'piCesmep'
   OUT            = 'Analyse'
   frequency      = 'monthly'
   DateBegin      = '18500101'
   CesmepSlices   = 4
   CesmepPeriod   = 1
   
which names are self-explanatory in C-ESM-EP and libIGCM contexts except these ones:
  - DateBegin    : the simulation start date
  - CesmepPeriod : the duration of atlas time slices 

The location for CliMAF cache is dedicated to the simulation and is $CCCSCRATCHDIR/cesmep_climaf_caches/${OUT}_${TagName}_${SpaceName}_${ExperimentName}_${JobName}

You can receive an email for the completion of each component's job and each new atlas slice by setting 'CesmepMail=TRUE' in config.card 



Example of config.card full content
--------------------------------------
Example::
   
  #D- Activate C-ESM-EP atlas by setting Cesmep to TRUE, to a number of years, or to SE, TS, Pack or AtEnd
  Cesmep=10Y
  #D- Configure C-ESM-EP 'comparison' (defaults to standard_comparison)
  CesmepComparison=run_comparison
  #D- Tell where is C-ESM-EP source code 
  CesmepCode=/ccc/cont003/home/igcmg/igcmg/Tools/cesmep/
  #D- How many time slices in C-ESM-EP atlas ?
  CesmepSlices=4
  #D - Send a mail for each component's job (and each Cesmep Period)
  CesmepMail=TRUE


For power users
----------------

Directory cesmep_lite/ does not include all files of a standard C-ESM-EP root directory, in order to save inodes (and this is achieved thanks to the PYTHONPATH set by libIGCM for running C-ESM-EP). If you wish to be able to modify such missing files for further customizing your run, just copy them in cesmep_lite/ and change them the way you like. This should occur after ins_job call and before submitting the simulation job.


