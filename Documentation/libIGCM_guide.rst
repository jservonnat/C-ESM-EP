=========================================================
C-ESM-EP user guide for the case of a libIGCM simulation
=========================================================

S.Senesi - sept 2022

Changes :
   - feb 2023 : Spirit is managed
   - jul 2023 : Jean Zay is managed

Pre-requisites :
  - some basic knowledege of C-ESM-EP (i.e. organization of a C-ESM-EP home directory, and concept of a 'comparison')
  - how to run a libIGCM simulation


When running a simulation (yet only at TGCC on Irene and Irene-rome, at IDRIS on Jean-Zay and at ISPL mesocenter on Spirit) you can trigger the computation of a C-ESM-EP atlas based on one of the output types (Seasonal, TimeSeries, packed Output, or even Output on scratch for e.g. a TEST simulation). This works when using a libIGCM version from trunk with a release number >= xxx

The atlas shows a series of the most recent time slices of the running simulation. Slices number and duration are tunable. 

Basic use
===========

Init phase
----------

At TGCC ad IDRIS, because C-ESM-EP requires a number of software packages, C-ESM-EP uses either TGCC's tool 'pcocc-rs' (see https://pcocc.readthedocs.io/) or IDRIS installed software 'singularity', and you must tell this tool where to find a relevant environment, by interactively issuing a few commands:

TGCC::

  pcocc-rs image import docker-archive:<file> cesmep_container

where <file> is the path for the most recent file in `/ccc/work/cont003/igcmg/igcmg/climaf_python_docker_archives/` (ask your C-ESM-EP guru in case of trouble). If you already executed that command before (for importing another file), you have to first discard that file `pcocc-rs image delete cesmep_container` 

IDRIS::

    module load singularity
    idrcontmgr cp /gpfswork/rech/psl/commun/Tools/cesmep_environment/<file>

 where <file> is the most recent '.sif' file there (ask your C-ESM-EP guru in case of trouble). You must check using `idrcontmgr ls` that you have only one registered file; use `idrcontmgr rm ...` to discard any other file.

This init pahse should be done only once by each user. The paths above are correct at the time of writing and may change in the future.

You have also to make sure that you are allowed to use the Thredds. Please test it using commad thredds_cp.

On Spirit, there is no need for such an init phase.
	

Settings:
---------

Computing a C-ESM-EP atlas is triggered using parameter 'Cesmep' in section Post of the config.card, which can be set to :

- TRUE, or <nyears>Y, for using the most efficient output type (among those which are generated by the simulation, so SE else TS else packed Outputs). The form <nyears>Y allows to explicitly set the atlas time slice duration (hereafter called CesmepPeriod)
- SE, TS, or Pack, for selecting explicitly an output type and its time slice duration (CesmepPeriod); that output type should be activated independently
- AtEnd for running the atlas only at simulation end, from Output type data (this works for TEST simulations with output on scratch)
- FALSE for deactivating any C-ESM-EP atlas (which is the default)

In same section, parameter 'CesmepSlices' allows to set the number of time slices to show in atlas (it defaults to 8).

Example of config.card minimal content (in section 'Post')::

  #D- Activate C-ESM-EP atlas by setting Cesmep to TRUE or to a number of years or ...
  Cesmep=5Y


How it works
------------

When installing a simulation using `ins_job`, the C-ESM-EP code (from a reference code version) is partially copied to `$SUMBIT_DIR/cesemp_lite/`, which becomes the root C-ESM-EP directory for that simulation.

The C-ESM-EP comparison that is ran by default is `run_comparison` and, in directory cesmep_lite/, that comparison name is further prefixed by your JobName (this matters when looking for outputs, see below)

Except for case `AtEnd`, the atlas is computed each time a batch of output is available for the selected type, provided it allows to process a new time slice. Time slicing is aligned with simulation start date and complies with values for parameters CesmepSlices and CesmepPeriod.

The account used for C-ESM-EP jobs is the one used by libIGCM for the simulation. If you wish to change it, please edit file `cesmep_lite/settings.py` accordingly, after execution of `ins_job` and before the end of first simulation period.



Outputs 
----------

The standard output of last C-ESM-EP launch is availabe in $SUMBIT_DIR/cesemp_lite/libIGCM_post.out, and the output for each component is located, as for all C-ESM-EP runs, in the component directory

The atlas main page is available on thredds/work like for other C-ESM-EP simulation e.g., if JobName is 'myFG2' on Irene, atlas main index can be found at:

   https://thredds-su.ipsl.fr/thredds/fileServer/tgcc_thredds/work/senesis/C-ESM-EP/myFG2_mycomparison_senesis/C-ESM-EP_myFG2_mycomparison.html

The actual value for your simulation can be found in the file quoted above, $SUMBIT_DIR/cesemp_lite/libIGCM_post.out




Advanced use
============

By default, the C-ESM-EP code used is a shared one (which location shows below); this can be changed using config.card's Post section's parameter `CesmepCode`.

The reference C-ESM-EP code locations are :
- at TGCC  : ~igcmg/Tools/cesmep
- at IDRIS : /gpfswork/rech/psl/commun/Tools/cesmep
- on spirit: /net/nfs/tools/Users/SU/jservon/cesmep_installs/cesmep_for_libIGCM

The C-ESM-EP 'comparison' can be chosen using config.card's Post parameter `CesmepComparison`.

The comparison 'components' are activated based on the simulation physical components; their list can be changed manually after running `ins_job` by editing file $SUMBIT_DIR/cesemp_lite/libIGCM_post.param (which fields are: Cesmep code location, comparison name, simulation start date, cache location, components list)

At that stage, you may also change component parameters in component directories in $SUMBIT_DIR/cesemp_lite/. You may also make changes to the datasets_setup.py source for customizing the datasets to use; for that, you can make use of the variables available in comparison's directory file libIGCM_fixed_settings.py, as e.g. :: 

   root           = '/ccc/store/cont003/gen0826'
   Login          = 'senesis'
   TagName        = 'IPSLCM6'
   SpaceName      = 'DEVT'
   ExpType        = 'piControl'
   ExperimentName = 'piCesmep'
   OUT            = 'Analyse'
   frequency      = 'monthly'
   DateBegin      = '18500101'
   CesmepSlices   = 4
   CesmepPeriod   = 1

which names are self-explanatory in C-ESM-EP and libIGCM contexts except these ones:

- DateBegin    : the simulation start date
- CesmepPeriod : the duration of atlas time slices 

The location for CliMAF cache is dedicated to the simulation and under a root path chosen by C-ESM-EP ::
    ${root}/cesmep\_climaf\_caches/${OUT}_${TagName}_${SpaceName}_${ExperimentName}_${JobName}.

With:
  - on Irene, root=${CCCSCRATCHDIR}
  - on Jean-Zay, root=$SCRATCH.
  - on Spirit, root=/scratchu/$user.

You can receive mails for the completion of each new atlas slice by setting ::
  CesmepMail=TRUE
in config.card, and by providing your email adress in config.card (parameter MailName in section UserChoices, which defaults to content of ~/.forward. Depending on the content of file `cesmep_lite/settings.py` (see there variable `one_mail_per_component`), you will get a mail for each component's job, or a mail for the set of jobs.



Example of config.card full content
--------------------------------------
Example::
   
  #D- Activate C-ESM-EP atlas by setting Cesmep to TRUE, to a number of years,
  #D- or to SE, TS, Pack or AtEnd. This defines the atlas period. Defaults to FALSE
  Cesmep=10Y
  #D- Name of C-ESM-EP 'comparison' to run (defaults to run_comparison)
  CesmepComparison=run_comparison
  #D- Tell where is C-ESM-EP source code (yet mandatory on spirit)
  CesmepCode=/ccc/cont003/home/igcmg/igcmg/Tools/cesmep/
  #D- How many time slices in C-ESM-EP atlas. Defaults to 8
  CesmepSlices=4
  #D - Send mail for each Cesmep Period (either one or one per component, depending on settings.py)
  CesmepMail=TRUE


For power users
----------------

Directory `cesmep_lite/` does not include all files of a standard C-ESM-EP root directory, in order to save inodes (and this is achieved thanks to the PYTHONPATH set by libIGCM for running C-ESM-EP, and by symbolic links for some other files). If you wish to be able to modify such files for further customizing your run, just copy them in cesmep_lite/ and change them the way you like. This should occur after ins_job call and before submiting the simulation job.


